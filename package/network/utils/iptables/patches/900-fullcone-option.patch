From 386bb8378bc67b7dfc3db5d5f28a01620b4231cf Mon Sep 17 00:00:00 2001
From: Kiran Kella <kiran.kella@broadcom.com>
Date: Wed, 7 Aug 2019 07:22:42 -0700
Subject: [PATCH] From 92f5aee7372748845f11b7a10d880f968769e860 Mon Sep 17
 00:00:00 2001 Subject: [PATCH] Passing fullcone option for SNAT and DNAT

---
 extensions/libipt_DNAT.c       | 37 ++++++++++++++++++++++++++++++++--
 extensions/libipt_MASQUERADE.c | 22 +++++++++++++++++++-
 extensions/libipt_SNAT.c       | 22 +++++++++++++++++++-
 3 files changed, 77 insertions(+), 4 deletions(-)

--- a/extensions/libxt_DNAT.c
+++ b/extensions/libxt_DNAT.c
@@ -26,14 +26,20 @@
 	.max_proto	= TO_IPV4_MRC(ptr)->range[0].max,	\
 };
 
+/* Temporarily defining here, need to be picked up from the
+ * new kernel header linux/netfilter/nf_nat.h */
+#define NF_NAT_RANGE_FULLCONE  (1 << 10)
+
 enum {
 	O_TO_DEST = 0,
 	O_TO_PORTS,
 	O_RANDOM,
 	O_PERSISTENT,
+	O_FULLCONE,
 	F_TO_DEST  = 1 << O_TO_DEST,
 	F_TO_PORTS = 1 << O_TO_PORTS,
 	F_RANDOM   = 1 << O_RANDOM,
+	F_FULLCONE  = 1 << O_FULLCONE
 };
 
 static void DNAT_help(void)
@@ -42,7 +48,7 @@ static void DNAT_help(void)
 "DNAT target options:\n"
 " --to-destination [<ipaddr>[-<ipaddr>]][:port[-port]]\n"
 "				Address to map destination to.\n"
-"[--random] [--persistent]\n");
+"[--random] [--persistent] [--fullcone]\n");
 }
 
 static void DNAT_help_v2(void)
@@ -51,7 +57,7 @@ static void DNAT_help_v2(void)
 "DNAT target options:\n"
 " --to-destination [<ipaddr>[-<ipaddr>]][:port[-port[/port]]]\n"
 "				Address to map destination to.\n"
-"[--random] [--persistent]\n");
+"[--random] [--persistent] [--fullcone]\n");
 }
 
 static void REDIRECT_help(void)
@@ -68,6 +74,7 @@ static const struct xt_option_entry DNAT
 	 .flags = XTOPT_MAND},
 	{.name = "random", .id = O_RANDOM, .type = XTTYPE_NONE},
 	{.name = "persistent", .id = O_PERSISTENT, .type = XTTYPE_NONE},
+	{.name = "fullcone", .id = O_FULLCONE, .type = XTTYPE_NONE},
 	XTOPT_TABLEEND,
 };
 
@@ -259,10 +266,14 @@ static void __DNAT_fcheck(struct xt_fche
 {
 	static const unsigned int redir_f = F_TO_PORTS | F_RANDOM;
 	static const unsigned int dnat_f = F_TO_DEST | F_RANDOM;
+	static const unsigned int c = F_FULLCONE;
 
 	if ((cb->xflags & redir_f) == redir_f ||
 	    (cb->xflags & dnat_f) == dnat_f)
 		*flags |= NF_NAT_RANGE_PROTO_RANDOM;
+
+	if ((cb->xflags & c) == c)
+		*flags |= NF_NAT_RANGE_FULLCONE;
 }
 
 static void DNAT_fcheck(struct xt_fcheck_call *cb)
@@ -327,6 +338,8 @@ static void __NAT_print(const struct nf_
 		printf(" %srandom", flag_pfx);
 	if (r->flags & NF_NAT_RANGE_PERSISTENT)
 		printf(" %spersistent", flag_pfx);
+	if (r->flags & NF_NAT_RANGE_FULLCONE)
+		printf(" %sfullcone", flag_pfx);
 }
 #define __DNAT_print(r, family) __NAT_print(r, family, "to:", "", false)
 #define __DNAT_save(r, family) __NAT_print(r, family, "--to-destination ", "--", false)
@@ -369,6 +382,10 @@ __DNAT_xlate(struct xt_xlate *xl, const
 		xt_xlate_add(xl, "%spersistent", sep);
 		sep = ",";
 	}
+	if (r->flags & NF_NAT_RANGE_FULLCONE) {
+		xt_xlate_add(xl, "%sfullcone", sep);
+		sep = ",";
+	}
 	return 1;
 }
 
--- a/extensions/libipt_MASQUERADE.c
+++ b/extensions/libipt_MASQUERADE.c
@@ -8,10 +8,15 @@
 #include <linux/netfilter_ipv4/ip_tables.h>
 #include <linux/netfilter/nf_nat.h>
 
+/* Temporarily defining here, need to be picked up from the
+ * new kernel header linux/netfilter/nf_nat.h */
+#define NF_NAT_RANGE_FULLCONE  (1 << 10)
+
 enum {
 	O_TO_PORTS = 0,
 	O_RANDOM,
 	O_RANDOM_FULLY,
+	O_FULLCONE
 };
 
 static void MASQUERADE_help(void)
@@ -23,13 +28,16 @@ static void MASQUERADE_help(void)
 " --random\n"
 "				Randomize source port.\n"
 " --random-fully\n"
-"				Fully randomize source port.\n");
+"				Fully randomize source port.\n"
+" --fullcone\n"
+"				Do fullcone NAT mapping.\n");
 }
 
 static const struct xt_option_entry MASQUERADE_opts[] = {
 	{.name = "to-ports", .id = O_TO_PORTS, .type = XTTYPE_STRING},
 	{.name = "random", .id = O_RANDOM, .type = XTTYPE_NONE},
 	{.name = "random-fully", .id = O_RANDOM_FULLY, .type = XTTYPE_NONE},
+	{.name = "fullcone", .id = O_FULLCONE, .type = XTTYPE_NONE},
 	XTOPT_TABLEEND,
 };
 
@@ -104,6 +112,9 @@ static void MASQUERADE_parse(struct xt_o
 	case O_RANDOM_FULLY:
 		mr->range[0].flags |=  NF_NAT_RANGE_PROTO_RANDOM_FULLY;
 		break;
+	case O_FULLCONE:
+		mr->range[0].flags |=  NF_NAT_RANGE_FULLCONE;
+		break;
 	}
 }
 
@@ -126,6 +137,9 @@ MASQUERADE_print(const void *ip, const s
 
 	if (r->flags & NF_NAT_RANGE_PROTO_RANDOM_FULLY)
 		printf(" random-fully");
+
+	if (r->flags & NF_NAT_RANGE_FULLCONE)
+		printf(" fullcone");
 }
 
 static void
@@ -145,6 +159,9 @@ MASQUERADE_save(const void *ip, const st
 
 	if (r->flags & NF_NAT_RANGE_PROTO_RANDOM_FULLY)
 		printf(" --random-fully");
+
+	if (r->flags & NF_NAT_RANGE_FULLCONE)
+		printf(" --fullcone");
 }
 
 static int MASQUERADE_xlate(struct xt_xlate *xl,
@@ -166,6 +183,9 @@ static int MASQUERADE_xlate(struct xt_xl
 	if (r->flags & NF_NAT_RANGE_PROTO_RANDOM)
 		xt_xlate_add(xl, "random ");
 
+	if (r->flags & NF_NAT_RANGE_FULLCONE)
+		xt_xlate_add(xl, "fullcone ");
+
 	return 1;
 }
 
--- a/extensions/libipt_SNAT.c
+++ b/extensions/libipt_SNAT.c
@@ -8,14 +8,20 @@
 #include <linux/netfilter_ipv4/ip_tables.h>
 #include <linux/netfilter/nf_nat.h>
 
+/* Temporarily defining here, need to be picked up from the
+ * new kernel header linux/netfilter/nf_nat.h */
+#define NF_NAT_RANGE_FULLCONE  (1 << 10)
+
 enum {
 	O_TO_SRC = 0,
 	O_RANDOM,
 	O_RANDOM_FULLY,
 	O_PERSISTENT,
+	O_FULLCONE,
 	F_TO_SRC       = 1 << O_TO_SRC,
 	F_RANDOM       = 1 << O_RANDOM,
 	F_RANDOM_FULLY = 1 << O_RANDOM_FULLY,
+	F_FULLCONE     = 1 << O_FULLCONE
 };
 
 static void SNAT_help(void)
@@ -24,7 +30,7 @@ static void SNAT_help(void)
 "SNAT target options:\n"
 " --to-source [<ipaddr>[-<ipaddr>]][:port[-port]]\n"
 "				Address to map source to.\n"
-"[--random] [--random-fully] [--persistent]\n");
+"[--random] [--random-fully] [--persistent] [--fullcone]\n");
 }
 
 static const struct xt_option_entry SNAT_opts[] = {
@@ -33,6 +39,7 @@ static const struct xt_option_entry SNAT
 	{.name = "random", .id = O_RANDOM, .type = XTTYPE_NONE},
 	{.name = "random-fully", .id = O_RANDOM_FULLY, .type = XTTYPE_NONE},
 	{.name = "persistent", .id = O_PERSISTENT, .type = XTTYPE_NONE},
+	{.name = "fullcone", .id = O_FULLCONE, .type = XTTYPE_NONE},
 	XTOPT_TABLEEND,
 };
 
@@ -148,12 +155,15 @@ static void SNAT_fcheck(struct xt_fcheck
 {
 	static const unsigned int f = F_TO_SRC | F_RANDOM;
 	static const unsigned int r = F_TO_SRC | F_RANDOM_FULLY;
+	static const unsigned int c = F_TO_SRC | F_FULLCONE;
 	struct nf_nat_ipv4_multi_range_compat *mr = cb->data;
 
 	if ((cb->xflags & f) == f)
 		mr->range->flags |= NF_NAT_RANGE_PROTO_RANDOM;
 	if ((cb->xflags & r) == r)
 		mr->range->flags |= NF_NAT_RANGE_PROTO_RANDOM_FULLY;
+	if ((cb->xflags & c) == c)
+		mr->range->flags |= NF_NAT_RANGE_FULLCONE;
 
 	mr->rangesize = 1;
 }
@@ -192,6 +202,8 @@ static void SNAT_print(const void *ip, c
 		printf(" random-fully");
 	if (mr->range->flags & NF_NAT_RANGE_PERSISTENT)
 		printf(" persistent");
+	if (mr->range->flags & NF_NAT_RANGE_FULLCONE)
+		printf(" fullcone");
 }
 
 static void SNAT_save(const void *ip, const struct xt_entry_target *target)
@@ -207,6 +219,8 @@ static void SNAT_save(const void *ip, co
 		printf(" --random-fully");
 	if (mr->range->flags & NF_NAT_RANGE_PERSISTENT)
 		printf(" --persistent");
+	if (mr->range->flags & NF_NAT_RANGE_FULLCONE)
+		printf(" --fullcone");
 }
 
 static void print_range_xlate(const struct nf_nat_ipv4_range *r,
@@ -254,6 +268,12 @@ static int SNAT_xlate(struct xt_xlate *x
 		if (sep_need)
 			sep = ",";
 		xt_xlate_add(xl, "%spersistent", sep);
+		sep_need = true;
+	}
+	if (mr->range->flags & NF_NAT_RANGE_FULLCONE) {
+		if (sep_need)
+			sep = ",";
+		xt_xlate_add(xl, "%sfullcone", sep);
 	}
 
 	return 1;
